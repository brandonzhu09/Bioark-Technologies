<div class="checkout-container">
    <mat-accordion>
        <!-- Shipping Panel -->
        <mat-expansion-panel
            [expanded]="isShippingPanelOpen"
            [disabled]="isShippingPanelDisabled"
        >
            <mat-expansion-panel-header>
                <mat-panel-title> 1. Shipping Information </mat-panel-title>
                <mat-panel-description class="preview-container">
                    @if (showShippingPreview) {
                    <div class="shipping-preview">
                        <div>
                            <strong>{{ shippingPreview.name }}</strong>
                        </div>
                        <div>{{ shippingPreview.address }}</div>
                        <div>{{ shippingPreview.cityStateZip }}</div>
                    </div>
                    <button
                        mat-button
                        color="primary"
                        (click)="editShipping(); $event.stopPropagation()"
                    >
                        Edit
                    </button>
                    }
                </mat-panel-description>
            </mat-expansion-panel-header>

            <form [formGroup]="shippingForm" (ngSubmit)="onShippingSubmit()">
                <div class="form-row">
                    <mat-form-field appearance="outline">
                        <mat-label>First Name</mat-label>
                        <input matInput formControlName="firstName" required />
                        <mat-error
                            *ngIf="
                                shippingForm
                                    .get('firstName')
                                    ?.hasError('required')
                            "
                        >
                            First name is required
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Last Name</mat-label>
                        <input matInput formControlName="lastName" required />
                        <mat-error
                            *ngIf="
                                shippingForm
                                    .get('lastName')
                                    ?.hasError('required')
                            "
                        >
                            Last name is required
                        </mat-error>
                    </mat-form-field>
                </div>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Address</mat-label>
                    <input matInput formControlName="address" required />
                    <mat-error
                        *ngIf="
                            shippingForm.get('address')?.hasError('required')
                        "
                    >
                        Address is required
                    </mat-error>
                </mat-form-field>

                <div class="form-row">
                    <mat-form-field appearance="outline">
                        <mat-label>City</mat-label>
                        <input matInput formControlName="city" required />
                        <mat-error
                            *ngIf="
                                shippingForm.get('city')?.hasError('required')
                            "
                        >
                            City is required
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>State</mat-label>
                        <mat-select formControlName="state" required>
                            @for (state of states; track state.code) {
                            <mat-option [value]="state.code">
                                {{ state.name }}
                            </mat-option>
                            }
                        </mat-select>
                        <mat-error
                            *ngIf="
                                shippingForm.get('state')?.hasError('required')
                            "
                        >
                            State is required
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>ZIP Code</mat-label>
                        <input matInput formControlName="zipCode" required />
                        <mat-error
                            *ngIf="
                                shippingForm
                                    .get('zipCode')
                                    ?.hasError('required')
                            "
                        >
                            ZIP code is required
                        </mat-error>
                        <mat-error
                            *ngIf="
                                shippingForm.get('zipCode')?.hasError('pattern')
                            "
                        >
                            Please enter a valid ZIP code
                        </mat-error>
                    </mat-form-field>
                </div>

                <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="!shippingForm.valid"
                >
                    Continue to Billing
                </button>
            </form>
        </mat-expansion-panel>

        <!-- Billing Panel -->
        <mat-expansion-panel [disabled]="isBillingPanelDisabled">
            <mat-expansion-panel-header>
                <mat-panel-title> 2. Billing Information </mat-panel-title>
            </mat-expansion-panel-header>

            <form [formGroup]="billingForm" (ngSubmit)="onBillingSubmit()">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Name on Card</mat-label>
                    <input matInput formControlName="cardName" required />
                    <mat-error
                        *ngIf="
                            billingForm.get('cardName')?.hasError('required')
                        "
                    >
                        Name on card is required
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Card Number</mat-label>
                    <input matInput formControlName="cardNumber" required />
                    <mat-error
                        *ngIf="
                            billingForm.get('cardNumber')?.hasError('required')
                        "
                    >
                        Card number is required
                    </mat-error>
                    <mat-error
                        *ngIf="
                            billingForm.get('cardNumber')?.hasError('pattern')
                        "
                    >
                        Please enter a valid 16-digit card number
                    </mat-error>
                </mat-form-field>

                <div class="form-row">
                    <mat-form-field appearance="outline">
                        <mat-label>Expiry Date (MM/YY)</mat-label>
                        <input
                            matInput
                            formControlName="expiryDate"
                            required
                            placeholder="MM/YY"
                        />
                        <mat-error
                            *ngIf="
                                billingForm
                                    .get('expiryDate')
                                    ?.hasError('required')
                            "
                        >
                            Expiry date is required
                        </mat-error>
                        <mat-error
                            *ngIf="
                                billingForm
                                    .get('expiryDate')
                                    ?.hasError('pattern')
                            "
                        >
                            Please enter a valid expiry date (MM/YY)
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>CVV</mat-label>
                        <input matInput formControlName="cvv" required />
                        <mat-error
                            *ngIf="billingForm.get('cvv')?.hasError('required')"
                        >
                            CVV is required
                        </mat-error>
                        <mat-error
                            *ngIf="billingForm.get('cvv')?.hasError('pattern')"
                        >
                            Please enter a valid CVV
                        </mat-error>
                    </mat-form-field>
                </div>

                <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="!billingForm.valid"
                >
                    Place Order
                </button>
            </form>
        </mat-expansion-panel>

        <!-- Order Review Panel -->
        <mat-expansion-panel [expanded]="true" hideToggle>
            <mat-expansion-panel-header>
                <mat-panel-title> Order Review </mat-panel-title>
            </mat-expansion-panel-header>

            <div class="order-review">
                <div class="price-row">
                    <span>Subtotal</span>
                    <span>${{ formatPrice(orderSummary.subtotal) }}</span>
                </div>
                <div class="price-row">
                    <span>Estimated Tax</span>
                    <span>${{ formatPrice(orderSummary.tax) }}</span>
                </div>
                <mat-divider class="divider"></mat-divider>
                <div class="price-row total">
                    <span>Total</span>
                    <span>${{ formatPrice(orderSummary.total) }}</span>
                </div>
            </div>
        </mat-expansion-panel>
    </mat-accordion>
</div>
